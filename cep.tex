\documentclass{patmorin}
\listfiles
\usepackage{pat}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{paralist}
\usepackage[normalem]{ulem}
\usepackage{mathtools}

\usepackage{todonotes}
\usepackage{comment}

% david proposes the following additions
% \renewcommand{\ge}{\geqslant}
% \renewcommand{\le}{\leqslant}
% \renewcommand{\geq}{\geqslant}
% \renewcommand{\leq}{\leqslant}

\newcommand{\vida}[1]{{\color{DarkGreen} Vida: #1}}
\newcommand{\pat}[1]{\textcolor{Blue}{Pat: #1}}
\newcommand{\gwen}[1]{\textcolor{Purple}{Gwen: #1}}
\newcommand{\piotr}[1]{\textcolor{red}{Piotr: #1}}

% \numberwithin{equation}{lem}

\crefname{p}{}{}
\creflabelformat{p}{#2(#1)#3}

\newenvironment{clmproof}{\begin{proof}[Proof of Claim:]\renewcommand{\qedsymbol}{\rule{1ex}{1ex}}}{\end{proof}}

\usepackage[longnamesfirst,numbers,sort&compress]{natbib}

% \newcommand{\mathdefin}[1]{\color{brightmaroon}#1}}
\setlength{\parskip}{1ex}

% Document-specific commands and math operators
\DeclareMathOperator{\tw}{tw}
\DeclareMathOperator{\pw}{pw}
\DeclareMathOperator{\bw}{bw}
\DeclareMathOperator{\td}{td}
\DeclareMathOperator{\diam}{diam}
\DeclareMathOperator{\radius}{radius}
\DeclareMathOperator{\pth}{path}
\DeclareMathOperator{\mindist}{min-dist}
\DeclareMathOperator{\mindeg}{min-deg}
\DeclareMathOperator{\girth}{girth}
\DeclareMathOperator{\dist}{dist}
\DeclareMathOperator{\ld}{ld}
\DeclareMathOperator{\polylog}{polylog}
\DeclareMathOperator{\evol}{Evol}
\DeclareMathOperator{\ivol}{Ivol}
\DeclareMathOperator{\tvol}{Tvol}
\newcommand{\NN}{\mathbb{N}}
\newcommand{\GG}{\mathcal{G}}
\newcommand{\Oh}{\mathcal{O}}
\DeclareMathOperator{\thick}{th}

\DeclarePairedDelimiter\set{\{}{\}}

\title{\MakeUppercase{{E}rdős–{P}ósa property of cycles that are far apart}}

\author{
 Vida Dujmovi{\'c}\,\footnote{School of Computer Science and Electrical Engineering, University of Ottawa, Ottawa, Canada (\texttt{vida.dujmovic@uottawa.ca}). Research supported by NSERC and a University of Ottawa Research Chair.}
 \qquad
 Gwena\"el Joret\footnote{D\'epartement d'Informatique, Universit\'e libre de Bruxelles, Belgium ({\tt gwenael.joret@ulb.be}). G.\ Joret is supported by the Belgian National Fund for Scientific Research (FNRS) and by the Australian Research Council.}
 \qquad
 Piotr Micek\footnote{Department of Theoretical Computer Science, Jagiellonian University, Kraków, Poland (\texttt{piotr.micek@uj.edu.pl}). Research supported
 the National Science Center of Poland under grant UMO-2018/31/G/ST1/03718 within the BEETHOVEN program.}
 \qquad
 Pat Morin\footnote{School of Computer Science, Carleton University, Ottawa, Canada (\texttt{morin@scs.carleton.ca}). Research supported by NSERC and the Ontario Ministry of Research and Innovation.}}

\date{}


\begin{document}

\maketitle

\begin{abstract}
  We prove that there exists a function $f:\mathbb{N}\to\mathbb{N}$ such that for all nonnegative integers $k$ and $d$,  for every graph $G$,  either $G$ contains $k$ cycles such that vertices of different cycles have distance greater than $d$ in $G$, or there exists a subset $X$ of vertices of $G$ with $|X|\leq f(k)$ such that  $G-B_G(X,15d)$ is a forest.
\end{abstract}

\section{Introduction}

The \defin{length}, $|P|$, of a path $P$ is the number of edges in $P$.  For a graph $G$, and two vertices $x$ and $y$ of $G$, $\mathdefin{\dist_G(x,y)}$ is the length of a shortest path, in $G$, with endpoints $x$ and $y$.  For subsets $X$ and $Y$ of $V(G)$, $\mathdefin{\dist_G(X,Y)}:=\min\{\dist_G(x,y):(x,y)\in X\times Y\}$. For an integer $r\ge 0$ and a vertex $x$ of $G$, $\mathdefin{B_G(x,r)}:=\{y\in V(G):\dist_G(x,y)\le r\}$.  For a subset $S$ of $V(G)$, $\mathdefin{B_G(S,r)}:=\bigcup_{x\in S}B_G(x,r)$

Let $G$ be a graph and let $d$ be a non-negative integer.
A set $\mathcal{C}$ of cycles in $G$ is a \defin{$d$-packing of cycles in $G$} if $\dist_G(V(C),V(C'))> d$ for every two distinct $C,C'\in\mathcal{C}$.  We prove the following result, which was conjectured by \citet{ahn.gollin:coarse}:

\begin{thm}\label{thm:main-in-intro}
  There exists a function $f:\mathbb{N}\to\mathbb{N}$ such that for all nonnegative integers $k$ and $d$,  for every graph $G$,  either $G$ contains a $d$-packing of $k$ cycles, or  there exists a subset $X$ of vertices of $G$ with $|X|\leq f(k)$ such that  $G-B_G(X,15d)$ is a forest.
\end{thm}


\section{Definitions and Tools}

A graph $G$ is \defin{unicyclic} if $G$ contains at most one cycle.  Let $r$ be a positive integer and let $G$ be a graph.
A cycle $C$ in $G$ is \defin{$r$-unicyclic in $G$}
if $C$ is the only cycle in $G[B_G(V(C),r)]$.

For a cycle $C$ in a connected graph $G$, a \defin{$C$-rooted spanning BFS-unicycle} of $G$ is a spanning connected unicyclic subgraph $U$ of $G$ with $E(U)\supseteq E(C)$ and such that $\dist_U(v,V(C))=\dist_G(v,V(C))$ for each $v\in V(G)$.

For all positive integers $k$, define
\[
\mathdefin{s(k)}:=\begin{cases}
4k(\log k + \log\log k +4)&\textrm{if $k\geq2$}\\
2&\textrm{if $k=1$.}
\end{cases}
\]
\begin{thm}
[\citet{Simonovits67}]\label{thm:simonovits}
Let $k$ be a positive integer and
let $G$ be a graph with all vertices of degree $2$ or $3$.
If $G$ contains at least $s(k)$ vertices of degree $3$, then
$G$ contains $k$ vertex-disjoint cycles.
\end{thm}

Let $c$ be a positive integer and let $F$ be a forest. 
A \mathdefin{$c$-subtree} $H$ of $F$ is a subgraph of $F$ that contains at most $c$ components.
\begin{thm}[\citet{gyarfas.lehel:helly}]\label{thm:gyarfas-lehel-general}
   There exists a function $\ell^\star:\N\times\N\to\N$ such that the following is true. For every $k,c\in\N$ with $c\geq1$, for every forest $F$ and 
    every collection $\mathcal{A}$ of $c$-subtrees of $F$, either
   \begin{compactenum}[(a)]
     \item there are $k$ pairwise vertex-disjoint members of $F$; or
     \item there exist $X \subseteq V(F)$ such that 
     $|X|\leq \ell^\star(k,c)$ and 
     $X\cap A\neq\emptyset$ for every $A\in\mathcal{A}$. 
   \end{compactenum}
\end{thm}

\begin{comment}
\piotr{Here is a version we had in mind all the time. It is a bit of a mouthfull. And it is obvious that \cref{thm:gyarfas-lehel-general} implies \cref{thm:gyarfas-lehel}.}

Let $p$ be a positive integer and let $F_i$ be a forest for each $i\in[p]$. 
A tuple $(A_1,\ldots,A_p)$ is a  \mathdefin{$(p,c)$-subtree} of $(F_1,\ldots,F_p)$ if 
\begin{compactenum}[\rm(i)]
\item $A_i\subseteq V(F_i)$ for each $i\in[p]$; and
\item $F_i[A_i]$ consists of at most $c$ components.
\end{compactenum}
We say that two $(p,c)$-subtrees $(A_1,\ldots,A_p)$, $(B_1,\ldots,B_p)$ are \mathdefin{independent} if 
$A_i\cap B_i=\emptyset$ for all $i\in[p]$.
We say that a set $\mathcal{I}$ of $(p,c)$-subtrees is \mathdefin{independent} if
 $I$ and $J$ are independent for every two distinct $I,J\in\mathcal{I}$.
\begin{thm}[\citet{gyarfas.lehel:helly}]\label{thm:gyarfas-lehel}
   There exists a function $\ell:\N\times\N\times\N\to\N$ such that the following is true. For every $p,k,c\in\N$ with $c\geq1$, for every $p$-tuple of forests $\mathcal{F}=(F_1,\ldots,F_p)$ and 
    every collection $\mathcal{A}$ of $(p,c)$-subtrees of $\mathcal{F}$, either
   \begin{compactenum}[(a)]
     \item there exists a subfamily $\mathcal{I}$ of $\mathcal{A}$ such that $\mathcal{I}$ is independent and $\mathcal{I}$ is of size $k$; or
     \item there exist $X_i \subseteq V(F_i)$ for each $i\in[p]$ such that $\Sigma_{i\in[p]} |X_i|\leq \ell(p,k,c)$ and 
     for each $(A_1,\ldots,A_p)\in\mathcal{A}$ there exists $i\in[p]$ with $X_i\cap A_i\neq\emptyset$.
   \end{compactenum}
\end{thm}
\end{proof}
\end{comment}
\section{The proof}

\begin{lem}\label{short_or_unicycle_nearby}
  Let $R$ be an integer with $R\ge 0$.
  Let $G$ be a graph and let $C$ be a cycle in $G$.
  Then $B_G(V(C),3R)$ contains a cycle $C'$ such that
  \begin{compactenum}[(a)]
    \item $B_G(V(C'),R)$ is unicyclic; or\label{short_or_unicycle_nearby:unicyclic}
    \item $C'$ has length at most $6R+2$.\label{short_or_unicycle_nearby:short}
  \end{compactenum}
\end{lem}

\begin{proof}
  Let $C_0:=C$.
  We construct inductively a sequence of pairs $(C_i,Q_i)_{i\geq0}$ such that
  (1) $C_i$ is a cycle in $G$;
  (2) $Q_i\subseteq C_i\cap C$, $Q_i$ is connected and contains at least one edge; and
  (3) $C_i$ contains at most $4R+1$ edges not in $Q_i$.
  Note that these two conditions imply that there is a path $P_i\subseteq C_i$  such that
  $P_i$ and $Q_i$ are edge-disjoint and $C_i=P_i\cup Q_i$.
  Thus, $P_i$ is a path of length at most $4R+1$ with both endpoints in $C$
  which implies that all vertices of $P_i$ are in distance at most $2R$ from $C$.
  In particular, $C_i\subseteq B_G(V(C),2R)$.

  Let $i\geq0$ and suppose that we already have defined $C_i$.
  If $B_G(V(C_i),R)$ is unicyclic, then $C_i$ witnesses~\eqref{short_or_unicycle_nearby:unicyclic}.

  Now suppose that $B_G(V(C_i),R)$ contains a cycle $D$ different than $C_i$.
  Let $u$ be a vertex of $D$ that is of maximal distance from $C_i$ among all vertices in $D$.
  Let $P(u)$ be a shortest path from $C$ to $u$.
  Since $u$ is incident to two vertices in $D$ there is a neighbor $v$ of $u$ in $D$ that is not in $P(u)$.
  Let $P(v)$ be a shortest path from $C_i$ to $v$.
  Note that both $P(u)$ and $P(v)$ are of length at most $R$.
  If $P(u)\cup P(v)\cup\{uv\}$ contains a cycle, say $E$, then $E$ has length at most $2R+1$ and $E\subseteq B_G(V(C_i),R)\subseteq B_G(V(C),3R)$, so $E$ witnesses~\eqref{short_or_unicycle_nearby:short}.
  Thus, we assume that $P:=P(u)\cup P(v)\cup\{uv\}$ contains no cycle so it must be a path.
  Also the length of $P$ is at most $2R+1$.

  Now there are three possibilities:
  \begin{compactenum}
    \item Both endpoints of $P$ are in $V(P_{i})$.
    In this case, $P\cup P_{i}$ contains a cycle of length at most
    $(2R+1)+(4R+1)=6R+2$ and this cycle is contained in $B_G(V(C_i),R)\subseteq B_G(V(C),3R)$, so it satisfies~\eqref{short_or_unicycle_nearby:short}.
    \item Both endpoints of $P$ are in $V(Q_{i})\setminus V(P_{i})$.
    In this case, we take $C_{i+1}$ to be a cycle in $Q_{i}\cup P$ and
    we take $Q_{i+1}:= Q_i\cap C_{i+1}$. % and $P_{i+1}:=P\cap C_{i+1}$.
    This works because $P$ has two distinct endpoints in $Q_{i+1}$
    and therefore $Q_{i+1}$ contains at least one edge,
    $Q_{i+1}\subseteq Q_i\subseteq C$, and
    $|P_{i+1}|\leq|P|\leq 2R+1$.
    Furthermore, note that $|Q_{i+1}| < |Q_{i}|$ because $C_{i+1}$ does not contain either endpoint of $Q_{i}$.
    \item Exactly one endpoint of $P$ is in $V(P_{i})$.
    In this case, $C_{i}\cup P$ has two cycles that each contain $P$.
    Each edge of $P_{i}$ belongs to exactly one of these two cycles.
    Therefore one of these cycles uses at most $\lfloor\frac{4R+1}{2}\rfloor=2R$ edges of $P_{i}$.
    We take $C_{i+1}$ to be this cycle and define
    $Q_{i+1}=C_{i+1}\cap Q_i$. %, and $P_{i+1}=C_{i+1}\cap (P\cup P_{i})$.
    Thus, $|P_{i+1}| \leq 2R+|P|\leq 4R+1$.
    Furthermore, note that $|Q_{i+1}| < |Q_{i}|$ because $C_{i+1}$ does not contain one of the endpoints of $Q_{i}$.
  \end{compactenum}
  This process eventually produces the desired cycle $C'$ from the statement since, at each step in the process $|Q_i|$ decreases.
\end{proof}

%/\pat{Consider rephrasing in terms of a partition $Y$, $\overline{Y}$ of $B_G(V(C),R)$}

%A path $P$ in $G$ is \defin{$R$-acyclic} if $G[B_{G}(V(P),R)]$ is a tree.


% \begin{lem}\label{grow_unicycle}
%   Let $d,R$ be integers such that $0\leq d \leq R$.
%   Let $G$ be a graph and let $C$ be an $d$-unicyclic cycle in $G$.
%   Then either:
%   \begin{compactenum}[(a)]
%     \item $G$ has a $d$-packing of $k$ cycles; or
%     \label{grow_unicycle:item:packing}
%     \item %\piotr{simplest possible version}
%     there exists a partition $(Y,\overline{Y})$ of $B_G(V(C),R)$ and $X\subseteq V(G)$ of size $\Oh(k\log k)$ such that 
%     \begin{compactitem}
%         \item $C[\overline{Y}]$ is a path and $G[B_{G[\overline{Y}]}(V(C)\cap\overline{Y},R)]$ is a tree %\setminus YC-Y$ is an $R$-acyclic path in $G[\overline{Y}]$;
%         \item $G[\overline{Y}]$ is a tree;
%         and \item $Y\subseteq B_G(X,2R+d)$.
%     \end{compactitem}
%   \end{compactenum}
% \end{lem}

\begin{lem}\label{grow_unicycle}
  Let $d,R$ be integers such that $0\leq d \leq R$.
  Let $G$ be a graph and let $C$ be a $d$-unicyclic cycle in $G$. 
  Let $U$ be a spanning BFS-unicycle in $B_G(V(C),R)$.
  %and 
  %let $Y$ be the set of all vertices in $B_G(V(C_i),R)$ that are incident to an edge of $G[B_G(V(C_i),R]$ that is not an edge of $U$.
  Then either:
  \begin{compactenum}[(a)]
    \item $G$ has a $d$-packing of $k$ cycles; or
    \label[p]{grow_unicycle:item:packing}
    \item 
    % there 
    % exist % $Y\subseteq V(G)$ and 
    % $X\subseteq V(G)$ with $|X|<2k+s(k)$ such that $Y\subseteq B_G(X,2R+d+1)$.\label[p]{grow_unicycle:item:hitting}
    there exists $X\subseteq V(G)$ with $|X|<2k+s(k)$ such that $B_G(X,2R+d)$ contains at least one endpoint of each edge in $G[B_G(V(C_i),R)]- E(U)$.\label[p]{grow_unicycle:item:hitting}
    \label{grow_unicycle:item:hitting}
    % \begin{compactitem}
    %     % \item $G[B_G(V(C),R)]\setminus Y$ is a forest; \pat{Pay close attention that this is sufficient.}
    %     %\item $C-Y$ is an $R$-acyclic path in $G-Y$;
    %     \item $\dist_{G}(v,V(C))=\dist_{G-Y}(v,V(C)\setminus Y)$, for all $v\in B_G(V(C),R)\setminus Y$;
    %     % \item $\set{B_{G-Y}(V(C)\setminus Y,R),Y}$ is a partition of $B_G(V(C),R)$;
    %     and \item $Y\subseteq B_G(X,2R+d)$.
    % \end{compactitem}
  \end{compactenum}
\end{lem}


\begin{comment}
%\piotr{playground}
\begin{lem}\label{grow_unicycle}
  Let $d,R$ be integers such that $0\leq d \leq R$.
  Let $G$ be a graph and let $C$ be a $d$-unicyclic cycle in $G$.
  Then either:
  \begin{compactenum}[(a)]
    \item $G$ has a $d$-packing of $k$ cycles; or
    \label{grow_unicycle:item:packing}
    \item there exists $Y\subseteq V(G)$ and $X\subseteq V(G)$ with $|X|<2k+s(k)$ such that 
    \label{grow_unicycle:item:hitting}
    \begin{compactitem}
        \item $G[B_G(V(C),R)]\setminus Y$ is a forest; \pat{Pay close attention that this is sufficient.}
        %\item $C-Y$ is an $R$-acyclic path in $G-Y$;
        \item $\dist_{G}(v,V(C))=\dist_{G-Y}(v,V(C)\setminus Y)$, for all $v\in B_G(V(C),R)\setminus Y$;
        % \item $\set{B_{G-Y}(V(C)\setminus Y,R),Y}$ is a partition of $B_G(V(C),R)$;
        and \item $Y\subseteq B_G(X,2R+d)$.
    \end{compactitem}
  \end{compactenum}
\end{lem}
\end{comment}

\begin{comment}
\begin{lem}\label{grow_unicycle}
  Let $d,R$ be integers such that $0\leq d \leq R$.
  Let $G$ be a graph and let $C$ be a $d$-unicyclic cycle in $G$.
  Then either:
  \begin{compactenum}[(a)]
    \item $G$ has a $d$-packing of $k$ cycles; or
    \label{grow_unicycle:item:packing}
    \item %\piotr{simplest possible version}
    there exists $Y\subseteq V(G)$ and $X\subseteq V(G)$ with $|X|<2k+s(k)$ such that 
    \label{grow_unicycle:item:hitting}
    \begin{compactitem}
        \item $C-Y$ is an $R$-acyclic path in $G-Y$;
        \item $\set{B_{G-Y}(V(C)\setminus Y,R),Y}$ is a partition of $B_G(V(C),R)$;
        and \item $Y\subseteq B_G(X,2R+d)$.
    \end{compactitem}
  \end{compactenum}
\end{lem}
\end{comment}


% \begin{lem}\label{grow_unicycle}
%   Let $d,R$ be integers such that $0\leq d \leq R$.
%   Let $G$ be a graph and let $C$ be an $d$-unicyclic cycle in $G$.
%   Then either:
%   \begin{compactenum}[(a)]
%     \item $G$ has a $d$-packing of $k$ cycles; or
%     \label{grow_unicycle:item:packing}
%     \item %\piotr{simplest possible version}
%     there exists $Y\subseteq V(G)\setminus B_G(V(C),d)$ and $X\subseteq V(G)$ of size $\Oh(k\log k)$ such that 
%     \begin{compactitem}
%         \item $C$ is $R$-unicyclic in $G-Y$;
%         \item $G[B_G(V(C),R)]-Y$ is connected;
%         and \item $Y\subseteq B_G(X,2R+d)$.
%     \end{compactitem}
%   \end{compactenum}
% \end{lem}

\begin{proof}
  Let $G_{R}:=G[B_G(V(C),R)]$.
  For each $v\in G_{R}\setminus V(C)$, select a vertex $p_v$ 
  %(the \defin{BFS parent} of $v$) 
  such that $\dist_G(p_v,V(C))=\dist_G(v,V(C))-1$.
  Let $U$ 
  %(a \defin{BFS unicycle})
  be the subgraph of $G_{R}$ with vertex set $V(U):=V(G_{R})$ and edge set $E(U):=E(C)\cup\{vp_v:v\in V(U)\setminus V(C)\}$.  Let $e_0$ be an arbitrary vertex of $C$.  

  Let $e\in E(G_{R})\setminus E(U)$.
  We define $C_e$ to be the unique cycle in $U\cup \set{e}$ that does not contain $e_0$.
  Let $P_{e}$ be the path or cycle formed by the edges in $E(C_{e})\setminus E(C)$ and let $Q_{e}$ be the (possibly empty) path formed by the edges in $E(C_{e})\cap E(C)$.  
  If $C_e$ has no edges in $C$ then we say that $e$ is \defin{$C$-null}.
  Otherwise, we say that $e$ is \defin{$C$-nonnull}.
  
  Consider the auxiliary graph $H$ with the vertex-set $\set{e\mid e\in E(G_{R})\setminus E(U)}$ and two distinct elements $e$ and $e'$ are adjacent in $H$ if $\dist_G(V(P_{e}),V(P_{e'})) \le d$.  Let $I$ be a maximal independent set in $H$. 
  We split the proof into two cases: 
  (1) $|I|\ge k+4k\log k$ and in this case we are going to find a $d$-packing of $k$ cycles in $G$ so item~\cref{grow_unicycle:item:packing} holds;
  (2) $|I|< k+4k\log k$ and in this case we show that item~\cref{grow_unicycle:item:hitting} holds.

  
  Suppose first that $|I|\ge k+\frac{1}{2}s(k)$.
  Therefore,
  either $I$ contains at least $k$ edges that are $C$-null;
  or $I$ contains at least $\frac{1}{2}s(k)$ edges that are $C$-nonnull.

  If $I$ contains at least $k$ edges that are $C$-null, then let $J$ be the set of $C$-null edges in $I$.
  Consider two distinct $e,e'\in J$.
  Since both edges are $C$-null we have $P_e=C_e$ and $P_{e'}=C_{e'}$.
  Now since both edges are in $I$ we have $\dist_G(V(C_e),V(C_{e'}))=\dist_G(V(P_e),V(P_{e'}))>d$. 
  Thus, $\set{C_e \mid e\in J}$ is a $d$-packing of at least $k$ cycles in $G$ and \eqref{grow_unicycle:item:packing} holds.  
  
  If $I$ contains at least $\frac{1}{2}s(k)$ edges that are $C$-nonnull, then let $J$ be the set of $C$-nonnull edges in $I$.
  Let $G'$ be the graph obtained from $C$ by adding $P_e$ for each $e\in J$.
  Since $\dist_G(V(P_e),V(P_{e'}))>d\ge0$ for all distinct $e,e'\in J$, $G'$ contains only vertices of degree $2$ or $3$, and the degree-$3$ vertices correspond to the endpoints of paths in $\set{P_e \mid e\in J}$.
  Therefore, $G'$ contains $2|J|\geq s(k)$ vertices of degree $3$.
  
  By \cref{thm:simonovits}, $G'$ contains a set $\mathcal{D}$ of $k$ pairwise vertex-disjoint cycles.
  We claim that $\mathcal{D}$ is a $d$-packing in $G$.
  Let $D$ and $D'$ be two distinct cycles in $\mathcal{D}$.
  Let $v$ and $v'$ be vertices of $D$ and $D'$, respectively,
  such that $\dist_G(v,v')=\dist_G(V(D),V(D'))$.
  If $v\in V(D)\setminus V(C)$ and $v'\in V(D')\setminus V(C)$, then
  $v$ lies $P_e$ and $v'$ lies in $P_{e'}$ for some  $e,e' \in I$.
  Since $D$ and $D'$ are vertex-disjoint $e$ and $e'$ are distinct.
  Since $e,e'\in I$, we have $\dist_G(v,v') \geq \dist_G(V(P_e),V(P_{e'}))>d$, as desired.
  Thus, without lost of generality we assume that $v \in V(C)$.
  Let $P$ be a shortest path from $v$ to $v'$ in $G$.
  If $P$ contains a vertex outside $B_G(V(C),d)$, then
  $P$ starts at $v$ in $C$ and takes at least $d+1$ edges to leave $B_G(V(C),d)$. %and then takes at least one edge to return to $B_G(V(C),d)$.
  Thus, $|P|\geq d+1 > d$ in this case, as desired.
  
  Now suppose that $V(P)\subseteq B_G(V(C),d)$. 
  Recall that $C$ is $d$-unicyclic in $G$.
  Thus, $P$ consists of a segment $P'$ that uses edges of $C$ followed by a segment $P''$ that uses only edges not in $C$.
  Suppose now that $v'$ does not lie on $C$.
  In this case $v' \in V(P_{e'})$ for some $e'\in J$.
  Then $P_{e'}\subseteq D'$ and in particular both endpoints of $P_{e'}$ lie in $D'$.
  Since $P$ is a shortest path between $V(D)$ and $V(D')$,
  we conclude that $v'$ is an endpoint of $P_{e'}$ and in particular $v'$ lies in $C$, a contradiction.
  
  Thus, we have that both $v$ and $v'$ lie in $C$.
  Since $P$ is a shortest path between $V(D)$ and $V(D')$, no edge of $P$ is contained in $D$. Note also that $P$ contains at least one edge as $D$ and $D'$ are vertex-disjoint. Therefore, the first edge of $P$ is an edge of $C$ and $v$ is the endpoint of a path $P_e$ that is contained in $D$ and $e\in I$. Similarly, $v'$ is the endpoint of a path $P_{e'}$ that is contained in $D'$ and $e'\in I$. Therefore $\dist_G(v,v')\ge \dist_G(V(P_e),V(P_{e'}))>d$, as desired.
  Thus indeed $\mathcal{D}$ a $d$-packing of  $k$ cycles in $G$ and~\eqref{grow_unicycle:item:packing} holds.

  It remains to consider the case when $|I| < k+\frac{1}{2}s(k)$.
  Since $I$ is a maximal independent set in $H$, it is a dominating set in $H$: Every vertex of $H$ is either in $I$ or adjacent to a vertex in $I$.  In $G$ this corresponds to the fact that, for every edge of $e=uv\in E(G_R)\setminus E(U)$ there exists $e'=u'v'\in I$ such that $\dist_G(V(P_{e}),V(P_{e'}))\le d$.
  Since $\dist_G(u',V(C))\leq R$ and $\dist_G(v',V(C))\leq R$,
  we have $V(P_{e'}) \subseteq B_G(\set{u',v'},R)$. Since $\dist_G(V(P_e),V(P_{e'}))\le d$,  $B_G(\set{u',v'},R+d)$ contains a vertex of $P_e$.
  Finally, $\dist_G(u,V(C))\leq R$ and $\dist_G(v,V(C))\leq R$ implies that
  $B_{G}(\set{u',v'},R+d+R)$ contains at least one of $u$ or $v$.  
\end{proof}
%   \pat{Simplify from this point onward.  No more $Y_0$, etc.Let $Y_0\subseteq V(G)\setminus B_G(V(C),d)$ be obtained by including the endpoints of each edge $e\in E(G_R)\setminus E(U)$ that are not in $B_G(V(C),d)$.  Since $C$ is $d$-unicyclic in $G$, each edge in $E(G_R)\setminus E(U)$ includes at least one endpoint in $Y_0$. Then $U-Y_0$ has a component $U_0$ that contains $C$.  Define $Y:=B_G(V(C),R)\setminus V(U_0)$.
  
%   Let $X\subseteq V(G)$ be the set obtained by taking both endpoints of $e$ for each $e\in I$.  
%   Thus, $|X|< 2k + s(k)$. 
%   We claim that $Y\subseteq B_G(X,2R+d+2)$. 
%   Let $y$ be a vertex of $Y$ and 
%   let $Q_y$ be the shortest path from $y$ to $V(C)$ in $U$. 
% %  Note that $|Q_y|\leq R$
%   Since $y\not\in V(U_0)$, there is a vertex $y_0\in V(Q_y)\cap Y_0$. 
%   Since $y_0\in Y_0$ there is an edge $e_0=x_0y_0 \in E(G_R)\setminus E(U)$. 
%   Since $I$ is a dominating set in $H$, 
%   either $e_0\in I$ or there exists $e=vw\in I$ such that $\dist_G(V(P_e),V(P_{e_0}))\leq d$.  
%   \piotr{I changed radius in the next sentence. Please check. What if $d=R=0$?} 
%   If $e_0\in I$, then $B_G(y_0,R-d-1)\supseteq V(Q_y)$, so $y\in B_G(X,R-d-1)$ and there is nothing more to do.  Suppose now that $e_0\not\in I$, so  there exists $e=vw\in I$ such that $\dist_G(V(P_e),V(P_{e_0}))\leq d$.  Then \pat{Justify second inequality here:}
%   \piotr{What is $v$ and $w$?} \pat{$vw=e$.  (We can't have $e=xy$ since $y$ is already used.)}
%   \begin{align*}
%     \dist_G(\{v,w\},y) 
%     & \le \dist_G(\{v,w\},x_0)+1+\dist_G(y_0,y) \\
%     & \le R+d+\dist_G(V(C),x_0)+1+\dist_G(y_0,y) \\
%     & = R+d+\dist_G(V(C),x_0)+1+(\dist_G(V(C),y)-\dist_G(V(C),y_0) \\
%     & \le R+d+\dist_G(V(C),x_0)+1+(1+\dist_G(V(C),x_0)-\dist_G(V(C),y_0) \\
%     & = R+d+2+\dist_G(V(C),y_0) \\
%     & \le 2R+d+2 
%   \end{align*}
%   Since $v,w\in X$, $y\in B_G(X,2R+d+2)$, as required.
%   % Thus, $V(P_e)\subseteq B_G(\set{x,y}, R)\subseteq B_G(X, R)$ and $V(P_{e_0})\cap B_G(X,R+d)\neq \emptyset$. 
%   % Let $z$ be a vertex in $V(P_{e_0})\cap B_G(X,R+d)$
%   % Let $z'\in\set{x,y}$ be such that ...
%   %   \piotr{old:}  
%   % for each $e\in E(G_R)\setminus E(U)$, $B_G(X,2R+d)$ contains at least one endpoint of $e$, which we place in the set $Y$.  Then $C$ is $R$-unicyclic in $G-Y$ and $Y\subseteq B_G(X,2R+d)$, as required.
%   % \pat{Now finish up by putting $v_0$ in and all its descendants in $Y$ and putting $v_0$ in $X$}
% \end{proof}


\begin{lem}\label{double_unicycle}
  Let $R,d$ be integers with $0\leq 2d\leq R$.
  Let $G$ be a graph,
  let $C_1$ and $C_2$ be $d$-unicyclic cycles in $G$ such that
  $\dist_G(V(C_1),V(C_2))>2d$.
  %Let $Y_i\subseteq V(G)$ be such that $C_i-Y_i$ is an $R$-acyclic path in $G-Y_i$ and 
  %$\set{B_{G-Y_i}(V(C_i)\setminus Y_i,R),Y_i}$ forms a partition of $B_G(V(C_i),R)$, for each in $i\in[2]$.
  Then either:
  \begin{compactenum}[(a)]
    \item $G$ has a $d$-packing of $k$ cycles; or
    \item there exists $X\subseteq V(G)$ such that $|X|< s(k)$ and \[
    B_{G}(V(C_1),R)\cap B_{G}(V(C_2),R) \subseteq B_G(X,2R+d).% \cup B_G(Y_1\cup Y_2,R).
    \]
  \end{compactenum}
\end{lem}


\begin{comment}
\begin{lem}\label{double_unicycle}
  Let $R,d$ be integers with $0\leq 2d\leq R$.
  Let $G$ be a graph,
  let $C_1$ and $C_2$ be $d$-unicyclic cycles in $G$ such that
  $\dist_G(V(C_1),V(C_2))>2d$.
  Let $Y_i\subseteq V(G)$ be such that $C_i-Y_i$ is an $R$-acyclic path in $G-Y_i$ and 
  $\set{B_{G-Y_i}(V(C_i)\setminus Y_i,R),Y_i}$ forms a partition of $B_G(V(C_i),R)$, for each in $i\in[2]$.
  Then either:
  \begin{compactenum}[(a)]
    \item $G$ has a $d$-packing of $k$ cycles; or
    \item there exists $X\subseteq V(G)$ such that $|X|< s(k)$ and \[
    B_{G-Y_1}(V(C_1)\setminus Y_1,R)\cap B_{G-Y_2}(V(C_2)\setminus Y_2,R) \subseteq B_G(X,2R+d) \cup B_G(Y_1\cup Y_2,R).
    \]
  \end{compactenum}
\end{lem}
\end{comment}

\begin{proof}
    % Let $i\in[2]$.
    % Let $T_i = G[B_{G-Y_i}(V(C_i),R)]$.
    % For each vertex $v$ in $T_i$ let $P_{i,v}$ be the shortest path from $v$ to $V(C_i)\setminus Y_i$ in $T_i$. \pat{Continue here}
    For each $i\in[2]$, fix a $C_i$-rooted BFS unicycle $U_i$ of $G[B_G(V(C_i),R)]$ and, for each $v\in V(U_i)$, let $P_{i,v}$ be the shortest path from $v$ to $V(C_i)$ in $U_i$. 
    
    Let $v$ be in $B_G(V(C_1),R)\cap B_G(V(C_2),R)$.
    Define $Q_v:= P_{1,v}\cup P_{2,v}$.
    Let $W=\set{v \in V(U_1)\cap V(U_2) \mid V(Q_v)\cap (Y_1\cup Y_2) =\emptyset}$.
    Let $w \in W$.
    Define $P_w$ to be a shortest path from $V(C_1)$ to $V(C_2)$ in $Q_w$.
    Note that $P_w$ is a path between $V(C_1)$ and $V(C_2)$ in $G-(Y_1\cup Y_2)$.

%    Note that for every $v \in W$, for each $i\in[2]$,
%    $P_v \cap U_i=P_v\cap G[V(U_i)]$.
    %Note that $P_v$ consists of two segments:
    %$u_1P_vv$ and $vP_vw_2$, where $u_i\in V(C_i)$ %for each $i\in[2]$ and each segment is ...

    Let $H$ be an auxiliary graph with the vertex set $W$ and such that two distinct vertices $w$ and $w'$ are adjacent in $H$ if $\dist_G(V(P_w),V(P_{w'}))\leq d$.
    Let $I$ be a maximal independent set in $H$.

    Suppose that $|I|\geq \frac{1}{2}s(k)$.
    Let $G'$ be the subgraph of $G$ obtained from $C_1\cup C_2$ by adding $P_w$ for each $w\in I$.
    Since $\dist_G(V(P_w),V(P_{w'}))>d\ge0$ for all distinct $w,w'\in I$, $G'$ contains only vertices of degree $2$ and degree $3$, and the degree-$3$ vertices correspond to the endpoints of paths in $\set{P_w\mid w\in I}$.
    Therefore, $G'$ contains $2|I|\geq s(k)$ vertices of degree $3$.
    By \cref{thm:simonovits}, $G'$ contains a set $\mathcal{D}$ of $k$ pairwise vertex-disjoint cycles.

    We claim that $\mathcal{D}$ is a $d$-packing in $G$.
    Let $D$ and $D'$ be two distinct cycles in $\mathcal{D}$.
    Let $w$ and $w'$ be vertices of $D$ and $D'$, respectively,
    such that $\dist_G(w,w')=\dist_G(V(D),V(D'))$.
    Suppose first that $w\in V(P_v)$ and $w'\in V(P_{v'})$ for some  $v,v' \in I$.
    Since $D$ and $D'$ are vertex-disjoint, $v$ and $v'$ are distinct.
    Since $v,v'\in I$, we have $\dist_G(w,w') \geq \dist_G(V(P_v),V(P_{v'}))>d$, as desired.

    Now suppose that $w, w' \in V(C_i)$ for some $i\in[2]$.
    Consider a shortest path $P$ from $w$ to $w'$ in $G$.
    Recall that $C_i$ is $d$-unicyclic in $G$.
    Thus, if $P$ contains a vertex not in $C_i$, then $P$ contains a vertex outside $B_G(V(C_i),d)$ and so $\dist_G(w,w')=|P|>2d+2$.
    Now suppose that $P\subseteq C_i$.
    Since $P$ is a shortest path between $V(D)$ and $V(D')$, no edge of $P$ lies in $D\cup D'$.
    Therefore $G'$ contains two edges of $D$ incident to $w$ and a third edge in $P$ (and in $C_i$) incident to $w$.
    Therefore $w$ has degree $3$ in $G'$, so $w\in V(P_{v})$ and $P_v\subseteq D$.
    In particular, $v\in I$.
    By the same argument, $w'\in V(P_{v'})$ and $v'\in I$.
    Since $D$ and $D'$ are vertex-disjoint $v\neq v'$.
    Therefore, $\dist(v,w)\ge \dist(V(P_v),V(P_{v'}))>d$.


    Now suppose that $w\in V(C_1)$ and $w'\in V(C_2)$.
    In this case we simply have that
    $\dist_G(V(D),V(D'))=\dist_G(w,w')\geq \dist_G(V(C_1),V(C_2))>2d\geq d$, as desired.
    (The case that $w\in V(C_1)$ and $w'\in V(C_2)$ is completely symmetric.)

    It remains to consider the case that
    $w\in V(C_1)$ and $w'\in V(P_{v'})- (V(C_1)\cup V(C_2))$ for some $v'\in I$.  Let $P'$ be the maximal subpath of $P_{v'}$ that contains the endpoint of $P_{v'}$ in $V(C_1)$ and that is contained in $B_{G-Y_1}(V(C_1),R)$. Let $P''$ be the subpath of $P_{v'}$ formed by the edges of $P_{v'}$ not in $P'$.  ($P''$ may have no edges.)

    If $w'\in V(P')$ then let $P$ be a shortest path in $G$ from $w$ to $w'$.  If $P$ contains a vertex not in $B_G(V(C_1),d)$ then $|P|> d$.
    Now suppose that $V(P)\subseteq B_G(V(C_1),d)$.
    Since $C_1$ is $d$-unicyclic in $G$, $P$ consists of a segment of $C_1$ followed by a segment of $P'$.
    Since $P$ is a shortest path between $V(D)$ and $V(D')$, no edge of $P$ lies in $D\cup D'$.  Therefore, $w$ is incident to two edges of $D$ and a third edge of $P$ in $C_1$.  Therefore $w\in V(P_v)$ for some $v\in I$ and $P_v\subseteq D$.  Since $D$ and $D'$ are vertex-disjoint, $v\neq v'$.  Therefore $\dist_G(w,w')\ge\dist_G(V(P_v),V(P_{v'}))>d$.

    Now assume $w'\in V(P'')$ and suppose, for the sake of contradiction that $\dist_G(w,w')\le d$. Therefore $\dist_G(V(C_1),w')\le d$.  Then $P''$ begins at a vertex $x$ with $\dist_G(x,V(C_1))\ge R+1$, then proceeds to $w'$ using at least $R+1-d$ edges and then proceeds to $C_2$ using at least $\dist_G(V(C_1),V(C_2))-\dist_G(V(C_1),w')\ge 2d+1-d=d+1$ edges.  Therefore $P''$ has at least $R+2$ edges.  Therefore $P_v$ has length at least $2R+3$. This is a contradiction because $P_v\subseteq Q_v$ and $Q_v$ has at most $2R$ edges.

    Now suppose that $|I|<\frac{1}{2}s(k)$.
    Since $I$ is a maximal independent set in $H$, the set $I$ is also a dominating set:
    For every $w\in W$ either $w\in I$ or $w$ has a neighbor in $I$.

    Let $X:=\set{x \in V(G) \mid \textrm{$x$ is an endpoint of $P_v$ for some $v\in I$}}$. 
    Note that $|X|\leq 2\cdot|I| < s(k)$. 
    We claim that
    $B_{G-Y_1}(V(C_1),R)\cap B_{G-Y_2}(V(C_2),R)\subseteq B_G(X\cup Y_1\cup Y_2,R)$.

    Consider a vertex $v \in B_{G-Y_1}(V(C_1),R)\cap B_{G-Y_2}(V(C_2),R)$.
    We split into two cases: $v\not\in W$ and $v\in W$.
    If $v\not\in W$, then $Q_v$ contains a vertex $y \in Y_1\cup Y_2$.
    Then $\dist_G(y,v) \leq R$ and therefore
    $v\in B_G(Y_1\cup Y_2,R)$, as desired.
    If $v\in W$, then we again split into two cases: $v\in I$ and $v\notin I$.
    If $v\in I$, then both endpoints of $P_v$ are in $X$ so $v\in B_G(X,R)$.
    If $v\notin I$, then there exists some $v'\in I$ such that $\dist_G(V(P_v),V(P_{v'}))\le d$.
    Both endpoints of $P_{v'}$ are in $X$, so $B_G(X,R)$ contains $V(P_{v'})$.  Then $B_G(X,R+d)$ contains some vertex of $P_v$.  Since $\dist_G(v,x)\le R$ for each $x\in V(P_v)$, $B_G(X,2R+d)$ contains $v$.
\end{proof}


\begin{thm}\label{thm:the-big-ball-of-wax}
  Let $f$ and $g$ be the following functions:
  \[
    \textstyle f(x)=
  x\cdot (2+x+s(x)) + \binom{x}{2}\cdot s(x) + \ell^\star(x+s(x),3), \qquad
    g(x)= 15x.
  \]
  For all non-negative integers $d$ and $k$, for every graph $G$, either $G$ contains a $d$-packing of $k$ cycles or there exists $X\subseteq V(G)$ with $|X|\leq f(k)$ such that $G-B_G(X,g(d))$ is a forest.
\end{thm}

\begin{proof}
  Let $d$ and $k$ be nonnegative integers and let $G$ be a graph. If $G$ contains a $d$-packing of $k$ cycles then there is nothing to prove. Thus, assume the opposite. Let $\set{\mathdefin{C_1,\ldots,C_p}}$ be a maximal $2d$-packing of cycles that are $d$-unicyclic in $G$.  Since $G$ has no $d$-packing of $k$ cycles, $p<k$.

  Consider the following iterative process, that is used to produce a set $M$ of marked vertices in $G$.  Begin with every vertex of $G$ \defin{unmarked}.  While $G$ contains a cycle $D$ having no marked vertices and no vertex in $B_G(\bigcup_{i=1}^p V(C_i),5d)$, do the following:  Apply \cref{short_or_unicycle_nearby} to $D$ to find a cycle $D'$ with all vertices in  $B_G(V(D),3d)$ such that either $|D'|\leq 6d+2$ or $D'$ is $d$-unicyclic in $G$. Since $V(D)\cap B_G(\bigcup_{i=1}^p V(C_i),5d)=\emptyset$ and $V(D')\subseteq B_G(V(D),3d)$, we have that $V(D')\cap B_G(\bigcup_{i=1}^p V(C_i),2d)=\emptyset$. Since $\{C_1,\ldots,C_p\}$ is maximal, $D'$ is not $d$-unicyclic in $G$.  Therefore $D'$ has length at most $6d+2$.  \defin{Mark} all vertices in $B_G(V(D'),d)$. This completes the description of the process.  Let $\mathdefin{M}$ be the set of vertices of $G$ marked by the process and let $D'_1,\ldots,D'_{q}$ be the sequence of cycles found by this process. Then $\{D'_1,\ldots,D'_q\}$ is a $d$-packing of cycles in $G$.  Since $G$ has no $d$-packing of $k$ cycles, $q<k$. 
  Let $\mathdefin{X_M}:=\{x_1,\ldots,x_{q}\}$ where  $x_i$ is an arbitrary vertex of $D'_i$ for each $i\in\{1,\ldots,q\}$. 
  Since $|D_i'|\leq 6d+2$, we have $V(D_i')\subseteq B_G(x_i,3d+1)$ for each $i\in[q]$. 
  Therefore, 
\begin{align}
  M&\subseteq B_G(X_M,4d+1)\text{, and}\label{eq:M-contained-in-a-ball}\\
  |X_M|&< k.\label{eq:XM-size}
\end{align}
%$M\subseteq B_G(X_M,4d+1)$.

The stopping condition of the process described above ensures that 
every cycle in $G-M$ contains a vertex in $\bigcup_{i=1}^p B_G(V(C_i),5d)$.

Let
\[
\mathdefin{R}:=7d\enspace .
\]
For each $i\in\{1,\ldots,p\}$, 
let \mathdefin{$U_i$} be a $C_i$-rooted spanning BFS-unicycle of $G[B_G(V(C_i),R)]$ that includes all edges of $C_i$.
For each $i\in\{1,\ldots,p\}$, 
apply \cref{grow_unicycle} to obtain 
a set $\mathdefin{Y_i}\subseteq V(G)$ and 
a set $\mathdefin{X_i}\subseteq V(G)$ such that 
every edge in $G[B_G(V(C_i),R)]-E(U_i)$ contains a vertex in $Y_i$,
\begin{align}
    Y_i&\subseteq B_G(X_i,2R+d)\text{, and}\label{eq:Yi-contained-in-a-ball}\\
    |X_i|&<2k+s(k).\label{eq:Xi-size}
\end{align}
For each $i,j\in[p]$ with $i\neq j$, let $\mathdefin{Y_{\set{i,j}}}:=B_G(V(C_i),R)\cap B_G(V(C_j),R)$ and apply \cref{double_unicycle} to $C_i$ and $C_j$ to obtain $\mathdefin{X_{\set{i,j}}}\subseteq V(G)$ such that 
\begin{align}
Y_{\set{i,j}}&\subseteq B_G(X_{\set{i,j}},2R+d)\text{, and} \label{eq:Yij-in-a-ball}\\
|X_{\set{i,j}}|&< s(k).\label{eq:Xij-size}
\end{align}
%of size $\Oh(k\log k)$ such that $Y_{\set{i,j}}\subseteq B_G(X_{\set{i,j}},2R+d) \cup B_G(Y_i\cup Y_j,R)$.

For each $i\in[p]$, let \mathdefin{$y_i$} be an arbitrary vertex of $C_i$.
Define
\begin{align*}
  \mathdefin{\widehat{M}}&:= \textstyle M \cup \bigcup_{i=1}^p Y_i \cup \bigcup_{\set{i,j}\in\binom{[p]}{2}} Y_{\set{i,j}}\cup\bigcup_{i\in[p]}\set{y_i},\ \textrm{and}\\
  \mathdefin{\widehat{X}}&:=\textstyle X_M\cup \bigcup_{i\in[p]} X_i\cup \bigcup_{\set{i,j}\in\binom{[p]}{2}}X_{\set{i,j}}\cup\bigcup_{i\in[p]}\set{y_i}.
\end{align*}
Note that by~\eqref{eq:M-contained-in-a-ball}, \eqref{eq:Yi-contained-in-a-ball}, and~\eqref{eq:Yij-in-a-ball} we have
\begin{equation}\label{m_in_x_ball}
\begin{split}
\widehat{M}&\textstyle\subseteq B_G(X_M,4d+1) \cup \bigcup_{i\in[p]} B_G(X_i,2R+d) \cup \bigcup_{\set{i,j}\in\binom{[p]}{2}} B_G(X_{\set{i,j}},2R+d)\\
&\subseteq B_G(\widehat{X}, 15d), 
\end{split} 
\end{equation}
and by~\eqref{eq:XM-size}, \eqref{eq:Xi-size}, \eqref{eq:Xij-size} we have
\begin{equation}
\begin{split}
|X'|& \textstyle \leq |X_M| + \sum_{i\in[p]}|X_i| + \sum_{\set{i,j}\in\binom{[p]}{2}} |X_{\set{i,j}}| + \sum_{i\in[p]} |\{y_i\}|  \\
&\textstyle< k + k\cdot (k+s(k)) + \binom{k}{2}\cdot s(k) + k \\
&\textstyle= k\cdot(2+k+s(k)) + \binom{k}{2}\cdot s(k)
\end{split} \label{x_prime_size}
\end{equation}
Let
\begin{align*}
\mathdefin{F_0}&:=\textstyle{G-\left(\widehat{M}\cup \bigcup_{i\in[p]} B_G(V(C_i),R-2d)\right)}\text{, and}\\
\mathdefin{F^-_0}&:=\textstyle{G-\left(\widehat{M}\cup \bigcup_{i\in[p]} B_G(V(C_i),R-d)\right)} \enspace . 
\end{align*}
Since every cycle in $G-M$ contains a vertex in $\bigcup_{i=1}^p B_G(V(C_i),5d)$ and $M\subseteq \widehat{M}$, $F_0$ is an induced forest in $G$. By definition, $F^-_0$  is an induced forest in $F_0$.

For $i\in\{1,\ldots,p\}$, an \defin{$i$-exit edge} is an edge of $G$ with one endpoint in $B_G(V(C_i),R-d)$ and one endpoint in $F_0^-$.
A $4$-tuple $(e,i,e',j)$ is a \defin{good tuple} if
\begin{compactitem}
  \item $e$ is an $i$-exit edge;
  \item $e'$ is a $j$-exit edge;
  and \item $e\neq e'$ and $e$ and $e'$ are incident to the same component of $F_0^-$.
\end{compactitem}
Each good tuple $t:=(e,i,e',j)$  defines a walk $\mathdefin{W_t}:=P_1eP_0e'P_2$ in $G$ where
\begin{compactitem}
  \item $P_1$ is the shortest path in $U_i$ from $V(C_i)$ to the end point of $e$ in $B_G(V(C_i),R-d)$;
  \item $P_0$ is the unique path in $F_0^-$ from the endpoint of $e$ in $F^-_0$ to the endpoint of $e'$ in $F^-_0$; and
  \item $P_2$ is the shortest path in $U_j$ from the endpoint of $e'$ in $B_G(V(C_j),R-d)$ to $V(C_j)$.
\end{compactitem}
% \piotr{Make a note that first and legs are of length exactly $R-d$.} 
We call the path $P_0$ the \defin{forest leg} of $W_t$, $P_1$ the \defin{first leg} of $W_t$, and $P_2$ the \defin{second leg} of $W_t$.  The walk $eP_0e'$ is called the \defin{extended forest leg} of $W_t$.  Note that the first and second leg of $W_t$ each have exactly $R-d$ edges, while the forest leg of $W_t$ could be arbitrarily long.

A tuple $t$ is \defin{admissible} if $t$ is good and $B_G(V(W_t),d) \cap M' = \emptyset$.  The following lemma allows us to finish the proof by finding a set of balls that intersect the extended forest leg of each admissible tuple.

\begin{clm}\label{hit_cycle}
  Let $C$ be a cycle in $G$.  Then  $C$ contains a vertex in $B_G(M',R)$ or $C$ contains the extended forest leg of some admissible tuple.
\end{clm}

\begin{clmproof}
  We may assume that $C$ contains no vertex in $M'$ since, otherwise, there is nothing to prove.
  Since $F_0^-$ is an induced forest in $G$, $C$ must contain some vertex not in $F_0^-$.  Therefore $C$ contains a vertex in $B_G(V(C_i),R-d)$  for some $i\in\{1,\ldots,p\}$. Since $C$ contains no vertex in $Y_i\cup\{y_i\}$, $C$ also contains a vertex not in $B_G(V(C_i),R-d)$.

  Therefore, $C$ contains an edge $v_0v_1$ with $v_0\in B_G(V(C_i),R-d)$ and $v_1\not\in B_G(V(C_i),R-d)$.  Since $C$ has no vertex in $\bigcup_{i,j}Y_{\{i,j\}}$, $v_1\not\in B_G(V(C_j),R-d)$ for any $j\in[p]$. Since $C$ has no vertex in $M'$, $v_1\in V(F^-_0)$, so $v_0v_1$ is an $i$-exit edge.
  
  Consider the maximal path $v_1,\ldots,v_{r-1}$ in $C$ that contains $v_1$ and that is contained in $F_0^-$. Let $v_r$ be the neighbour of $v_{r-1}$ in $C-\set{v_{r-2}}$.  (Possibly $v_r=v_0$)  Since $v_r\notin M'$ and $v_r$ is not a vertex of $F_0^-$, $v_r\in B_G(V(C_j),R-d)$ for some $j\in\{1,\ldots,p\}$.   Then $v_{r-1}v_r$ is a $j$-exit edge and $v_0,\ldots,v_{r}$ is the extended forest leg of the good tuple $t:=(v_0v_1,i,v_{r-1}v_r,j)$.   If $t$ is admissible, then there is nothing more to prove.  If $t$ is not admissible, 
  then $B_G(V(W_t),d)$ contains a vertex of $M'$, say $m$.  
  Let $P_0=v_1,\ldots,v_{r-1}$ be the forest leg of $W_t$, let $P_1$ be the first leg of $W_t$ and let $P_2$ be the second leg of $W_t$. 
  If $m\in B_G(V(P_1),d)$ then there is $u\in V(P_1)$ such that $\dist_G(m,u)\leq d$ and so 
  $\dist_G(m,v_0)\le \dist_G(m,u) + \dist_G(u,v_0)\le d + (R-d)$.  
  If $m\in B_G(V(P_2),d)$ then $\dist_G(m,v_r)\le R$.  Similarly, if $m\in B_G(V(P_0,d)$ then $\dist_G(m,V(P_0)\le d$.  In each case $B_G(m,R)$ contains a vertex in $V(C)\supseteq \set{v_0,\ldots,v_r}$.
\end{clmproof}

% At this point it is tempting to mimic the proofs of \cref{grow_unicycle} and \cref{double_unicycle} and define an auxilliary graph $H$ with vertex set $V(H):=\{t:\textrm{$t$ is an admissible good tuple}\}$ and that contains an edge $st$ if and only if $\dist_G(V(W_s),V(W_t))\le d$. However, this does not work because $W_s$ and $W_t$ do not have diameter bounded by any function of $d$.  More precisely this fails because the assumption that $B_G(X,r)$ contains a vertex in the (extended) forest leg of $t$ does not imply that $B_G(X,r+g(d))$ contains a vertex in the (extended) forest leg of $s$, for any function $g$.  Instead we have to resort to the Hungarian Lemma, which is what the next paragraph is preparing for.

Let $t=(e,i,e',j)$ be an admissible tuple with $P_1eP_0e'P_2:=W_t$. Define the $(p+1)$-tuple $\mathdefin{\Psi(t)}:=(\Psi_0(t),\Psi_1(t),\ldots,\Psi_p(t))$ where
\begin{align*}
    \mathdefin{\Psi_\ell(t)} &:=
    \begin{cases}
        B_{G}(V(P_0),d)&\textrm{if $\ell=0$,}\\
        B_{G}(V(P_1),d)&\textrm{if $\ell=i$ and $\ell\neq j$,}\\
        B_{G}(V(P_2),d)&\textrm{if $\ell\neq i$ and $\ell= j$,}\\
        B_{G}(V(P_1),d)\cup B_{G}(V(P_2),d)&\textrm{if $\ell= i$ and $\ell= j$,}\\
        \emptyset&\textrm{if $\ell\notin\{0,i,j\}$.}
    \end{cases}
\end{align*}

For each $i\in[p]$, let 
\begin{align*}
\mathdefin{F_i}&:=G[B_G(V(C_i),R)]-\widehat{M},\\
\mathdefin{F_i^-}&:=G[B_G(V(C_i),R-d)]-\widehat{M}. 
\end{align*}
Since $\widehat{M}$ contains $Y_i$, $F_i$ is a subgraph of $U_i$.  Since $\widehat{M}$ contains $y_i\in V(C_i)$, $F_i$ is a forest.  Since $F^-_i$ is a subgraph of $F_i$, it is also a forest.
% is a subgraph $U_i[B_G(V(C_i,R-d)]$.

\begin{clm}\label{clm:three-components}
Let $t$ be an admissible tuple. Then
\begin{compactenum}[\rm(i)]
\item $G[\Psi_0(t)]$ is a connected subgraph of $F_0$,
\label[p]{item:Psi0-connected}
% \piotr{discuss definition of $F$}\pat{Why?} \piotr{We don't remove the $Y$-sets in the defintion of $F$.}
% \item $G[\Psi_\ell(t)]$ is a subgraph of $F_\ell$ that has at most two components, for each $\ell\in[p]$.\label[p]{item:Psil-connected}
\item $G[\Psi_\ell(t)]$ is a subgraph of $F_\ell$ and has $c_{\ell}$ components where $c_{\ell}\in\set{0,1,2}$, for each $\ell\in[p]$. 
Moreover, $\sum_{\ell\in[p]}c_{\ell}\leq 2$.
\label[p]{item:Psil-connected}
\end{compactenum}
\end{clm}

\begin{clmproof}\
    Let $t:=(e,i,e',j)$. 
    Let $P_0$, $P_1$, and $P_2$ be the forest leg, the first leg, and second leg of $W_t$, respectively.   For the proof of~\cref{item:Psi0-connected}, recall that $P_0$ is a connected subgraph of $F_0^-$. Since $t$ is admissible $B_G(V(P_0),d)$ contains no vertex in $M'$. Since $P_0\subseteq F_0^-$, $V(P_0)$ contains no vertex of $B_G(V(C_i),R-d)$ for each $i\in[p]$. Therefore, $B_G(V(P_0),d)$ contains no vertex in $B_G(V(C_i),R-2d)$ for any $i\in[p]$. Therefore $B_G(V(P_0),d)=B_{F_0}(V(P_0),d)$.
    Since $P_0$ is connected in $F_0$, 
    $B_{F_0}(V(P_0),d)$ induces a connected subgraph of $F_0$. 
    
    Now we prove~\cref{item:Psil-connected}. If $\ell\in [p]\setminus\{i,j\}$, then $\Psi_\ell(t)$ is empty, so $c_\ell=0$.
    % and there is nothing to prove.  
    Thus, it is sufficient to prove that $B_G(V(P_1))$ induces a connected subgraph of $F_i$ and that $B_G(V(P_2),d)$ induces a connected subgraph of $F_j$.  We prove the first of these statements, the proof of the second is symmetric.
    
    Since $P_1$ contains no vertex in $Y_i\cup\{y_i\}$, $P_1$ is a connected
    subgraph of $F_i^-$.  Since $V(F^-_i)\subseteq B_G(V(C_i),R-d)$, $B_G(V(P_1),d)\subseteq B_G(V(C_i),R)$.  Furthermore, $B_G(V(P_1),d)$ contains no vertex in $\widehat{M}$, so $B_G(V(P_1),d)=B_{F_i}(V(P_1),d)$. 
    Since $P_1$ is connected in $F_i$, 
    $B_{F_i}(V(P_1),d)$ induces a connected subgraph of $F_i$. 
\end{clmproof}


\begin{clm}\label{w_distance}
  Let $t_1$ and $t_2$ be admissible tuples.
  If $\Psi_i(t_1)\cap \Psi_i(t_2)=\emptyset$ for all $i\in\{0,\ldots,p\}$, 
  then $\dist_G(V(W_{t_1}),V(W_{t_2}))> d$.  
\end{clm}


% \pat{HMMMMM: Problems here caused by these stupid tuples with empty forest legs.  These still need to have a non-empty projection onto $F$.  Otherwise, the Hungarians have no way of knowing that the walk of $(e,i,d,j)$ is close to the walk of  $(e',i',d',j')$ when $|\{i,i',j,j'\}|=4$}

\begin{clmproof}
  Assume for the sake of contradiction that $\Psi_i(t_1)\cap\Psi_i(t_2)=\emptyset$ for all $i\in\{0,\ldots,p\}$ but there exists $v\in V(W_{t_1})$ and $w\in V(W_{t_2})$ with $\dist_G(v,w)=\dist_G(V(W_{t_1}),V(W_{t_2})) \le d$.
  Let $t_2=(e,i,e',j)$ and let $Q_0$, $Q_1$, and $Q_2$ be the forest, first, and second legs of $W_{t_2}$, respectively.

  We first consider the case in which $v$ is in the forest leg of $W_{t_1}$ or $w$ is in the forest leg of $W_{t_2}$.   Without loss of generality, suppose $v$ is in the forest leg $P_0$ of $W_{t_1}$. 
  Then $w\in B_G(v,d)\subseteq B_G(V(P_0),d)\subseteq\Psi_0(t_1)$.  Now we will show that $w\in \Psi_0(t_2)$.   Recall that $w$ lies in one of the three legs of $W_{t_2}$. 
  If $w\in V(Q_0)$ then $w\in V(Q_0)\subseteq \Psi_0(t_2)$ as desired. 
  Now assume $w$ lies in the first or second leg of $W_{t_2}$.
  Suppose without loss of the generality that $w\in V(Q_1)$. 
  Let $x$ be the endpoint of the $i$-exit edge $e$ that is contained in $Q_0$.
  Then $w\in B_G(x,d)\subseteq\Psi_0(t_2)$.
  Therefore $\Psi_0(t_1)\cap\Psi_0(t_2)\supseteq\{w\}\supsetneq\emptyset$.

  Next we consider the case where $v$ is not in the forest leg of $W_{t_1}$ and $w$ is not in the forest leg of $W_{t_2}$.  Without loss of generality, suppose $v$ is in the first leg $P_1$ of $W_{t_1}$ and $w$ is in the first leg $Q_1$ of $W_{t_2}$. 
  Recall that $t_2=(e,i,e',j)$, so $Q_1\subseteq F_i^-$. 
  Then $v\in B_G(w,d)\subseteq B_G(V(Q_1),d) = \Psi_i(t_2)$.  
  Since $t_2$ is admissible and $w\in V(F^-_i)$ we have that $B_G(w,d) \subseteq V(F_i)$ and so $v\in V(F_i)$. 
  Since $v\not\in V(F_0^-)$ and $v\not\in M'$, 
  $v\in B_G(V(C_j),R-d)$ for some $j\in\{1,\ldots,p\}$.  Since $v\notin Y_{\{i,j\}}$ for any $i\neq j$, it must be that $i=j$. Therefore $v\in V(F^-_i)$.  Therefore $v\in\Psi_i(t_1)$.
  Therefore, $\Psi_i(t_1)\cap\Psi_i(t_2)\supseteq\{v\}\supsetneq \emptyset$. 
\end{clmproof}


\begin{clm}\label{hungarians_hit}
  Let $X\subseteq V(G)$ and let $t:=(e,i,e',j)$ be an admissible tuple with extended forest leg $eP_0e'$ and such that $X\cap \Psi_\ell(t)\neq\emptyset$ for some $\ell\in\{0,\ldots,p\}$.  Then $B_G(X,R)\cap V(eP_0e')\neq\emptyset$.
\end{clm}

\begin{clmproof}
  Note that $\Psi_{\ell}(t)$ is non-empty only for the values of $\ell\in\set{0,i,j}$. 
  If $\ell=0$ then, by definition $X$ contains a vertex in $B_G(V(P_0),d)=\Psi_0(t)$.  Therefore $B_G(X,d)\subseteq B_G(X,R)$ contains a vertex of $P_0$ and there is nothing more to prove.
  Otherwise, let $P_1$ be the first leg of $t$ and let $P_2$ be the second leg of $t$.
  If $\ell=i$ then $\dist_G(X,V(P_1))\le d$.  Therefore $B_G(X,d)$ contains a vertex of $P_1$.  Therefore $B_G(X,R)$ contains all vertices of $P_1$, including the endpoint of $e$ in $P_1$.  If $\ell=j$, then the same argument shows that $B_G(X,R)$ contains the endpoint of $e'$ in $P_2$.
\end{clmproof}

Let $\mathdefin{F}$ be the forest obtained by taking 
disjoint copies $\mathdefin{F_0^\star,\ldots, F_p^\star}$ of $F_0,\ldots, F_p$, respectively.  That is,  $F_0^\star,\ldots, F_p^\star$ are pairwise vertex-disjoint and $F_i^\star$ is isomorphic to $F_i$, for each $i\in\{0,\ldots,p\}$.
For each $i\in\{0,\ldots,p\}$ and each $v\in V(F_i)$, define $\mathdefin{v_i}$ to be the unique vertex of $F^\star_i$ that corresponds to $v$.
% in $F^\star_i$.

Let $t$ be an admissible tuple. 
Let $\mathdefin{\Psi^\star(t)}:=\bigcup_{i=0}^p \{v_i:v\in \Psi_i(t)\}$.
By \cref{clm:three-components}, $F[\Psi^\star(t)]$ has at most three components. 
Let
\[
\mathdefin{\mathcal{A}}:=\{\Psi^\star(t):\text{$t$ is an admissible tuple}\}.
\]

By~\cref{thm:gyarfas-lehel-general} applied for
$\mathdefin{k'}:=s(k)+k$, $c=3$, $F$, and $\mathcal{A}$, at least one of the following is true:
\begin{inparaenum}[(a)]
  \item there are $k'$ pairwise vertex-disjoint members of $\mathcal{A}$; or 
  \item there exists $X'\subseteq V(F)$ with $|X'|\leq \ell^\star(k',3)$ and such that $X' \cap A\neq\emptyset$ for each $A\in \mathcal{A}$.
\end{inparaenum}

First, we consider outcome (b) and let $X'$ be the promised subset of $V(G)$.
Define 
\[
\mathdefin{X_H}:=\set{v:v_i\in X'}.
\]
Note that 
for every admissible tuple $t$,
\begin{equation}\label{eq:X_H}
X_H \cap \Psi_i(t) \neq\emptyset,\ \textrm{for some $i\in\set{0,\ldots,p}$.}
\end{equation}
Let
\[
\mathdefin{X}:=\widehat{X} \cup X_H \enspace .
\]
By~\eqref{x_prime_size}
\[
|X| = |\widehat{X}| + |X_H| < \textstyle k + k\cdot (k+s(k)) + \binom{k}{2}\cdot s(k) + k + \ell^\star(k+s(k),3) = f(k).
\]
We claim that every cycle $C$ in $G$ contains a vertex of 
\[
B_G(\widehat{X},15d)\cup B_G(X_H,R)\subseteq B_G(X,15d) = B_G(X,g(d)).
\]
In order to prove this claim, consider an arbitrary cycle $C$ in $G$. 
By~\cref{hit_cycle}, either $C$ contains a vertex in $B_G(\widehat{M},R)$ or $C$ contains the extended forest leg of some admissible tuple $t$. 
In the former case, by \eqref{m_in_x_ball}, $\widehat{M}\subseteq B_G(\widehat{X},15d)$ and we are done. 
Therefore, we can assume that $C$ contains the extended forest leg of $W_t$ for some admissible tuple $t$. 
By~\eqref{eq:X_H} and~\cref{hungarians_hit}, 
$B_G(X_H,R)$ contains a vertex of $C$.
This completes the proof of the claim.

Now we consider outcome (a): 
there are $k'$ pairwise vertex-disjoint members $\mathdefin{A_1,\ldots,A_{k'}}$ of $\mathcal{A}$. 
For each $j\in[k']$, let $\mathdefin{t_j}$ be an admissible tuple such that $A_j = \Psi^\star(t_j)$. 
Let $\mathdefin{T}:=\set{t_1,\ldots, t_{k'}}$. 
Therefore, for every $i\in[p]$ and every $t,t'\in T$ with $t\neq t'$ we have $\Psi_i(t) \cap \Psi_i(t') = \emptyset$. 
By \cref{w_distance}, 
\begin{equation}\label{eq:Wt-and-Wt-far-apart}
\dist_G(V(W_{t}), V(W_{t'}))> d, 
\end{equation}
for all $t,t'\in T$ with $t\neq t'$. 

Recall that, for each $t\in T$, $W_t$ is a path in $G$ or contains a cycle in $G$. 
Let $\mathdefin{J}:=\{t\in T:\text{$W_t$ contains a cycle}\}$.  By~\eqref{eq:Wt-and-Wt-far-apart} the cycles defined by $W_t$ for $t\in J$ define a $d$-packing of cycles in $G$.  Therefore $|J|<k$ and $|T\setminus J|\geq \tfrac{1}{2}s(k)$.

Define the graph $G':=\bigcup_{i=1}^p C_i\cup \bigcup_{t\in T\setminus J} W_{t}$.  
Note that all vertices of $G'$ are of degree $2$ or $3$.  Since $G'$ does not contain $W_t$ for any $t\in J$, each degree $3$ vertex of $G'$ is an endpoint of $W_{t}$ for some $t\in T\setminus J$. 
Therefore, $G'$ contains $2|T\setminus J|\geq s(k)$ vertices of degree $3$.
By \cref{thm:simonovits}, $G'$ contains a set $\mathcal{D}$ of $k$ pairwise vertex-disjoint cycles.  The degree-$3$ vertices of $G'$ partition the edges of each cycle in $\mathcal{D}$ into paths, where each such path is either contained in a cycle $C_i$ for some $i\in[p]$ or is a path $W_t$ for some $t\in T\setminus J$.  

We claim that $\mathcal{D}$ is a $d$-packing of cycles in $G$. 
Let $D$ and $D'$ be two distinct cycles in $\mathcal{D}$.  Let $P$ be a shortest path in $G$ from $V(D)$ to $V(D')$.  Let $v\in V(D)$ and $v'\in V(D')$ be the endpoints of $P$.  If $v\in W_t$ and $v'\in W_{t'}$ for some $t,t'\in T$ such that $W_t\subseteq D$ and $W_{t'}\subseteq D'$ then, by \eqref{eq:Wt-and-Wt-far-apart} $\dist_G(v,v')\ge \dist_G(V(W_t),V(W_t))>d$, as desired.  

Therefore, without loss of generality we may assume that $v\in V(C_i)$ for some $i\in[p]$ and that $v\notin V(W_t)$ for any $t$ with $W_t\subseteq D$.  If $P$ contains a vertex not in $B_G(V(C_i),d)$ then $|P|>d$, as required.  Now assume that $V(P)\subseteq B_G(V(C_i),d)$. Since $P$ is a shortest path, $E(P)\cap E(D)=\emptyset$ and $E(P)\cap E(D')=\emptyset$.  Since $C_i$ is $d$-unicyclic in $G$, $P$ consists of a path in $C_i$ followed by a path that is edge-disjoint from $C_i$. If the first edge of $P$ is contained in $C_i$ then the first edge of $P$ and the two edges of $D$ incident to $v$ are contained in $G'$.  Therefore $v$ is the endpoint of $W_t$ for some admissible tuple $t\in T\setminus J$ and such that $W_t\subseteq D$, which contradicts the choice of $v$.


If the first edge of $P$ is not contained in $C_i$ then, since $V(P)\subseteq B_G(V(C_i),d)$ and $C_i$ is $d$-unicyclic, $v'\not\in V(C_i)$.  Since $C_1,\ldots,C_p$ are a $2d$-packing of cycles in $G$, $v\not\in V(C_j)$ for any $j\in[p]$. Therefore $v'$ is in $W_{t'}$ for some admissible tuple $t'$.  This implies that the (first or second) leg of $W_{t'}$ that contains $v'$ has an endpoint in $C_i$.  Since $C_i$ is $d$-unicyclic, $P\subseteq W_{t'}\subseteq D'$, which contradicts the fact that $D$ and $D'$ are vertex-disjoint.
This completes the proof that $\mathcal{D}$ is a $d$-packing in $G$. 
Since $|\mathcal{D}|\geq k$ this is the final contradiction that completes the proof of \cref{thm:the-big-ball-of-wax}.
\end{proof}

\bibliographystyle{plainurlnat}
\bibliography{cep}
\end{document}
